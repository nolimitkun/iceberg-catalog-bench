# OpenCatalog REST Harness

This workspace contains a small Python harness that exercises the Snowflake OpenCatalog (Apache Polaris) REST APIs using the client credentials you provide at runtime. It covers management reads, catalog reads, and optional write flows (namespace, table, view, metrics).

## Prerequisites

- Python 3.9+
- `requests` and `jq` (for the quick shell examples below)
- OAuth client credentials with access to the target Polaris account

Set the basic environment variables used by the harness and the shell snippets:

```bash
export OC_ACCOUNT="pxlrpte-vs41448open.snowflakecomputing.com/polaris"
export OC_SCOPE="PRINCIPAL_ROLE:spark"
export OC_CRED="4Qdi+HwwOAIBmt2zDe2s8LktPCc=:yoursecret"
```

*(Optional)* To manually inspect responses, fetch a bearer token with curl:

```bash
export POLARIS_TOKEN=$(curl -sS -u "${OC_CRED}" \
  -d "grant_type=client_credentials&scope=${OC_SCOPE}" \
  "https://${OC_ACCOUNT}/api/catalog/v1/oauth/tokens" | jq -r .access_token)
```

## Harness Overview

The main entry point is `scripts/opencatalog_api_tester.py`. It handles OAuth token exchange then executes a suite of `HttpTest` definitions. Responses are grouped by surface and each call is classified as `PASS`, `EXP` (expected status such as known 403/406), or `FAIL`.

### Basic read-only sweep

```bash
python scripts/opencatalog_api_tester.py \
  --catalog rest_test \
  --namespace rest_test
```

This verifies:
- Management reads (catalog metadata, roles)
- Catalog reads (config, namespaces, tables, views)
- Known gaps (e.g., policy store disabled) are marked as expected rather than failures

### Enabling write coverage

Add `--include-writes` to create a scratch namespace, update it, and tear it down. By default the harness generates names and cleans everything up at the end.

```bash
python scripts/opencatalog_api_tester.py \
  --catalog rest_test \
  --namespace rest_test \
  --include-writes
```

Environment variables such as `OC_CATALOG`, `OC_NAMESPACE`, `OC_WAREHOUSE`, `OC_CLIENT_ID`, and `OC_CLIENT_SECRET` are also honored if you prefer to configure via the shell.

### Table, view, and metrics flows

Supply JSON templates from the `samples/` directory (or your own) to exercise additional functionality:

```bash
python scripts/opencatalog_api_tester.py \
  --catalog rest_test \
  --namespace rest_test \
  --include-writes \
  --table-create-spec samples/table_create_template.json \
  --view-create-spec samples/view_create_template.json \
  --table-metrics-spec samples/table_metrics_template.json
```

Flags you may find useful:

- `--table-require-success`, `--view-require-success`, `--metrics-require-success` – promote optional flows to hard failures if they do not complete.
- `--table-name` / `--view-name` – override the autogenerated resource names.
- `--keep-artifacts` – leave scratch resources around for inspection.
- `--verbose` – print full JSON payload excerpts instead of truncating to 160 characters.

Cleanup is automatically ordered so tables and views are dropped before the namespace.

## Template Variables

Templates are rendered with `string.Template.safe_substitute`. The following placeholders are available:

| Variable | Description |
|----------|-------------|
| `${catalog}` | Target catalog (prefix) |
| `${namespace}` | Scratch namespace name (dot separated) |
| `${table}` | Scratch table name |
| `${view}` | Scratch view name |
| `${warehouse}` | Warehouse hint used for config requests |
| `${namespace_location}` | Resolved namespace storage location |
| `${default_base_location}` | Default base location from `GET /v1/config` |
| `${timestamp}` / `${timestamp_ms}` | Current epoch time (seconds / milliseconds) |

If a template leaves `"location": "__AUTO__"`, the harness will expand it to `${namespace_location}/${table or view}` so resources land in the permitted storage subtree.

## Samples

- `samples/table_create_template.json` – Minimal Iceberg table definition (location auto-filled).
- `samples/view_create_template.json` – Spark SQL-based view pointing at the scratch table.
- `samples/table_metrics_template.json` – Skeleton metrics payload (defaults to a commit-style report).

Adapt these to your environment as needed (e.g., update SQL dialect, schema IDs, metrics).

## Manual API calls (reference)

The older curl examples are still useful for quick checks:

```bash
curl https://${OC_ACCOUNT}/api/management/v1/catalogs/rest_test \
  -H "Authorization: Bearer ${POLARIS_TOKEN}" | jq

curl https://${OC_ACCOUNT}/api/catalog/v1/rest_test/namespaces \
  -H "Authorization: Bearer ${POLARIS_TOKEN}" | jq

curl https://${OC_ACCOUNT}/api/catalog/v1/rest_test/namespaces/rest_test \
  -H "Authorization: Bearer ${POLARIS_TOKEN}" | jq

curl -sS -X PUT https://${OC_ACCOUNT}/api/management/v1/catalogs/rest_test \
-H "Authorization: Bearer $POLARIS_TOKEN" \
-H "Content-Type: application/json" \
-d '{ "currentEntityVersion": 1, "properties": { "default-base-location": "abfss://resttest@sfoc.blob.core.windows.net/exemple" } }'

curl -sS -X PUT https://${OC_ACCOUNT}/api/management/v1/catalogs/rest_test \
-H "Authorization: Bearer $POLARIS_TOKEN" \
-H "Content-Type: application/json" \
-d '{
  "type": "INTERNAL",
  "name": "rest_test",
  "properties": {
    "default-base-location": "abfss://resttest@sfoc.blob.core.windows.net/"
  },
  "currentEntityVersion": 9,
  "storageConfigInfo": {
    "tenantId": "81652c07-f8c1-4cca-8372-9146285e400c",
    "multiTenantAppName": "rjqd5csnowflakepacint_1753116968907",
    "consentUrl": "https://login.microsoftonline.com/81652c07-f8c1-4cca-8372-9146285e400c/oauth2/authorize?client_id=f1742a88-b184-45c6-9feb-04fe2ddaee35&response_type=code",
    "storageType": "AZURE",
    "allowedLocations": [
      "abfss://resttest@sfoc.blob.core.windows.net/",
      "abfss://newresttest@sfocdfs.dfs.core.windows.net"
    ]
  }
}'
```

## Troubleshooting

- **403 (Forbidden)** on management endpoints: the current principal lacks the necessary grants; these are treated as expected in the harness until you elevate privileges.
- **406 (UnsupportedOperation)** for policy routes: indicates the Polaris feature flag is disabled.
- **Storage path errors** during table/view creation: update your template to use a location within the catalog’s configured base path, or rely on the `__AUTO__` helper.

Feel free to extend `scripts/opencatalog_api_tester.py` with additional `HttpTest` definitions for scenarios specific to your deployment.

## Resaults

```
== Management API ==
[EXP] List catalogs: 403 | {"error":{"message":"Principal 'spark' with activated PrincipalRoles '[spark]' and activated grants via '[spark]' is not authorized for op LIST_CATALOGS","type"
[PASS] Describe catalog: 200 | {"type":"INTERNAL","name":"rest_test","properties":{"default-base-location":"abfss://resttest@sfoc.blob.core.windows.net/"},"createTimestamp":1758476086933,"las
[EXP] List catalog roles: 403 | {"error":{"message":"Principal 'spark' with activated PrincipalRoles '[spark]' and activated grants via '[spark, rw]' is not authorized for op LIST_CATALOG_ROLE
[EXP] List principal roles: 403 | {"error":{"message":"Principal 'spark' with activated PrincipalRoles '[spark]' and activated grants via '[spark]' is not authorized for op LIST_PRINCIPAL_ROLES"

== Catalog API ==
[PASS] Get config: 200 | {"defaults":{"default-base-location":"abfss://resttest@sfoc.blob.core.windows.net/"},"overrides":{"prefix":"rest_test"},"endpoints":["GET /v1/{prefix}/namespace
[PASS] List namespaces: 200 | {"namespaces":[["rest_test"]],"next-page-token":null}
[PASS] Describe namespace: 200 | {"namespace":["rest_test"],"properties":{"location":"abfss://resttest@sfoc.blob.core.windows.net/rest_test"}}
[PASS] Namespace exists: 204
[PASS] List tables: 200 | {"identifiers":[],"next-page-token":null}
[PASS] List views: 200 | {"identifiers":[],"next-page-token":null}
[EXP] Get applicable policies: 406 | {"error":{"message":"Feature not enabled: ENABLE_POLICY_STORE","type":"UnsupportedOperationException","code":406}}

== Management Writes ==
[PASS] Update catalog default base location: 200 | {"type":"INTERNAL","name":"rest_test","properties":{"default-base-location":"abfss://resttest@sfoc.blob.core.windows.net/codex-1759337139"},"createTimestamp":17
[PASS] Revert catalog default base location: 200 | {"type":"INTERNAL","name":"rest_test","properties":{"default-base-location":"abfss://resttest@sfoc.blob.core.windows.net/"},"createTimestamp":1758476086933,"las
[PASS] Update catalog allowed locations: 200 | {"type":"INTERNAL","name":"rest_test","properties":{"default-base-location":"abfss://resttest@sfoc.blob.core.windows.net/"},"createTimestamp":1758476086933,"las
[PASS] Revert catalog allowed locations: 200 | {"type":"INTERNAL","name":"rest_test","properties":{"default-base-location":"abfss://resttest@sfoc.blob.core.windows.net/"},"createTimestamp":1758476086933,"las

== Catalog Writes ==
[PASS] Create namespace (write): 200 | {"namespace":["rest_test_codex_1759337143"],"properties":{"created-at":"1759337143","location":"abfss://resttest@sfoc.blob.core.windows.net/rest_test_codex_1759
[PASS] Update namespace properties: 200 | {"removed":[],"updated":["owner"],"missing":[]}
[PASS] Namespace exists (write): 204
[PASS] Create table: 200 | {"metadata-location":"abfss://resttest@sfoc.blob.core.windows.net/rest_test_codex_1759337143/rest_test_codex_1759337143_tbl_1759337143/metadata/00000-75b02161-4
[PASS] Load table: 200 | {"metadata-location":"abfss://resttest@sfoc.blob.core.windows.net/rest_test_codex_1759337143/rest_test_codex_1759337143_tbl_1759337143/metadata/00000-75b02161-4
[PASS] Table exists: 204

== View Writes ==
[PASS] Create view: 200 | {"metadata-location":"abfss://resttest@sfoc.blob.core.windows.net/rest_test_codex_1759337143/rest_test_codex_1759337143_view_1759337150/metadata/00000-17cf61fe-
[PASS] Load view: 200 | {"metadata-location":"abfss://resttest@sfoc.blob.core.windows.net/rest_test_codex_1759337143/rest_test_codex_1759337143_view_1759337150/metadata/00000-17cf61fe-
[PASS] View exists: 204
[PASS] Replace view: 200 | {"metadata-location":"abfss://resttest@sfoc.blob.core.windows.net/rest_test_codex_1759337143/rest_test_codex_1759337143_view_1759337150/metadata/00000-17cf61fe-

== Table Metrics ==
[PASS] Report table metrics: 204

== Cleanup ==
[PASS] Drop table: 204
[PASS] Drop view: 204
[PASS] Drop namespace: 204

Executed 29 calls | Passed: 29 | Expected: 4 | Failed: 0
```